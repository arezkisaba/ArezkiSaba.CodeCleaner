using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Formatting;

namespace ArezkiSaba.CodeCleaner.Extensions;

public static class WorkspaceExtensions
{
    public static async Task<Workspace> CleanAndRefactorAsync(
        this Workspace workspace)
    {
        await workspace.CleanAsync();
        await workspace.RefactorAsync();
        return workspace;
    }

    #region Private use

    private static async Task CleanAsync(
        this Workspace workspace)
    {
        var cleaningFuncs = new List<(Func<Document, Task<Document>> func, Func<Project, Task<bool>> predicate)>();
        cleaningFuncs.Add(((document) => document.StartReadonlyModifierFieldRewriterAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartSealedModifierClassRewriterAsync(), async (project) => await project.IsNonNugetProjectAsync()));
        cleaningFuncs.Add(((document) => document.ReorderClassMembersAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartTypeInferenceRewriterAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartUsingDirectiveSorterAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartDuplicatedUsingDirectiveRemoverAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartDuplicatedEmptyLinesRemoverAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartEmptyLinesBracesRemoverAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartRegionInserterAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartMethodDeclarationParameterLineBreakerAsync(), (project) => Task.FromResult(true)));
        cleaningFuncs.Add(((document) => document.StartInvocationExpressionArgumentLineBreakerAsync(), (project) => Task.FromResult(true)));

        var newSolution = workspace.CurrentSolution;
        foreach (var projectId in workspace.CurrentSolution.ProjectIds)
        {
            var project = newSolution.GetProject(projectId);
            foreach (var documentId in project.DocumentIds)
            {
                var documentToUpdate = project.GetDocument(documentId);
                var rootToUpdate = await documentToUpdate.GetSyntaxRootAsync();
                if (documentToUpdate.IsAutoGenerated() || rootToUpdate.BeginsWithAutoGeneratedComment())
                {
                    continue;
                }

                foreach (var (func, predicate) in cleaningFuncs)
                {
                    var canExecuteFunc = await predicate(project);
                    if (!canExecuteFunc)
                    {
                        continue;
                    }

                    documentToUpdate = await func(documentToUpdate);
                }

                newSolution = documentToUpdate.Project.Solution;
            }
        }

        ApplyChanges(workspace, newSolution);
    }

    private static async Task RefactorAsync(
        this Workspace workspace)
    {
        var refactoringFuncs = new List<Func<Document, Solution, Task<(Document document, Solution solution)>>>();
        refactoringFuncs.Add((document, solution) => solution.StartFieldRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.StartEventFieldRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.StartPropertyRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.StartMethodRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.StartLocalVariableRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.StartParameterRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.StartUnusedMethodParameterRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.StartAsyncMethodRenamerAsync(document));
        refactoringFuncs.Add((document, solution) => solution.ReorderFieldsWithPropfullPropertiesAsync(document));

        var newSolution = workspace.CurrentSolution;
        foreach (var projectId in newSolution.ProjectIds)
        {
            var project = newSolution.GetProject(projectId);
            foreach (var documentId in project.DocumentIds)
            {
                var documentToUpdate = project.GetDocument(documentId);
                var rootToUpdate = await documentToUpdate.GetSyntaxRootAsync();
                if (documentToUpdate.IsAutoGenerated() || rootToUpdate.BeginsWithAutoGeneratedComment())
                {
                    continue;
                }

                foreach (var refactoringFunc in refactoringFuncs)
                {
                    (documentToUpdate, newSolution) = await refactoringFunc(documentToUpdate, newSolution);
                }
            }
        }

        ApplyChanges(workspace, newSolution);
    }

    private static void ApplyChanges(
        this Workspace workspace,
        Solution newSolution)
    {
        if (!ReferenceEquals(newSolution, workspace.CurrentSolution))
        {
            var changesApplied = workspace.TryApplyChanges(newSolution);
            if (changesApplied)
            {
            }
            else
            {
            }
        }
    }

    #endregion
}
